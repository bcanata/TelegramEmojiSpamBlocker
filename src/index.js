// List of one-word Turkish girl names
const turkishGirlNames = [
  "Abendam",
  "Açela",
  "Açelya",
  "Açılay",
  "Adel",
  "Adelya",
  "Adile",
  "Afitap",
  "Afra",
  "Ağça",
  "Ahenk",
  "Ahlem",
  "Alisa",
  "Almila",
  "Alvina",
  "Amelya",
  "Amara",
  "Andaç",
  "Anar",
  "Anise",
  "Anita",
  "Anka",
  "Alpike",
  "Altın",
  "Arın",
  "Arya",
  "Asuela",
  "Aslım",
  "Ayren",
  "Aykal",
  "Aysar",
  "Ayşıl",
  "Bade",
  "Bağdagül",
  "Balın",
  "Bediz",
  "Bedran",
  "Behrem",
  "Belçim",
  "Belma",
  "Beltun",
  "Belemir",
  "Belinda",
  "Benice",
  "Benli",
  "Berceste",
  "Berçin",
  "Berinay",
  "Berran",
  "Berre",
  "Berva",
  "Besra",
  "Çağıl",
  "Cangül",
  "Cannur",
  "Cansel",
  "Cansın",
  "Canel",
  "Ceren",
  "Ceyda",
  "Cilvenaz",
  "Ceylinaz",
  "Ceylin",
  "Ceyla",
  "Ceylan",
  "Çağla",
  "Çeşminaz",
  "Çıgıl",
  "Çiçek",
  "Çilay",
  "Çiler",
  "Çimen",
  "Çise",
  "Çişem",
  "Çisil",
  "Damla",
  "Defne",
  "Demet",
  "Deniz",
  "Derya",
  "Destan",
  "Deste",
  "Didem",
  "Dilan",
  "Dilara",
  "Dilay",
  "Diler",
  "Dilhan",
  "Dilek",
  "Dilruba",
  "Döndü",
  "Duygu",
  "Dünya",
  "Dürdane",
  "Dürriye",
  "Dicle",
  "Dolunay",
  "Destan",
  "Derin",
  "Diclehan",
  "Dilberay",
  "Ebru",
  "Ece",
  "Eda",
  "Ekin",
  "Ela",
  "Elçin",
  "Elif",
  "Elmas",
  "Elvan",
  "Emel",
  "Emine",
  "Enise",
  "Esen",
  "Eser",
  "Esin",
  "Esmeray",
  "Eylül",
  "Evşen",
  "Eftalya",
  "Ecem",
  "Eyşan",
  "Fadime",
  "Fahriye",
  "Fahrünissa",
  "Fatma",
  "Fatoş",
  "Fazilet",
  "Fehime",
  "Ferah",
  "Feray",
  "Ferda",
  "Feride",
  "Feriha",
  "Feyza",
  "Fidan",
  "Figen",
  "Fikriye",
  "Filiz",
  "Firdevs",
  "Fulya",
  "Fuldem",
  "Fulden",
  "Funda",
  "Füruzan",
  "Füsun",
  "Füreyya",
  "Gamze",
  "Gaye",
  "Gizem",
  "Gonca",
  "Gökben",
  "Gökçe",
  "Gökşin",
  "Gönül",
  "Gözde",
  "Güher",
  "Gül",
  "Gülbahar",
  "Gülben",
  "Gülçin",
  "Güldem",
  "Gülden",
  "Güldeste",
  "Gülen",
  "Gülşen",
  "Gülgün",
  "Gülnaz",
  "Gülpembe",
  "Gülriz",
  "Gülsen",
  "Günay",
  "Güneş",
  "Güner",
  "Güngör",
  "Güniz",
  "Günsel",
  "Günseli",
  "Gürcan",
  "Güven",
  "Göknur",
  "Günnur",
  "Hale",
  "Handan",
  "Hande",
  "Hayal",
  "Hayat",
  "Hazan",
  "Hilal",
  "Hülya",
  "Hümeyra",
  "Hüner",
  "Hürmüz",
  "Hürrem",
  "Hadise",
  "Hanzade",
  "Handesu",
  "Hansa",
  "Handan",
  "Henna",
  "Ilgın",
  "Işık",
  "Işıl",
  "Işılay",
  "Işın",
  "Itır",
  "İclal",
  "İdil",
  "İffet",
  "İkbal",
  "İlayda",
  "İlkben",
  "İlke",
  "İlknur",
  "İlksen",
  "İlkyaz",
  "İmge",
  "İmran",
  "İnci",
  "İpek",
  "İrem",
  "İzel",
  "Jale",
  "Julide",
  "Kade",
  "Kadriye",
  "Kamelya",
  "Kamile",
  "Kamuran",
  "Kevser",
  "Kumru",
  "Kısmet",
  "Kıymet",
  "Kiraz",
  "Lale",
  "Lamia",
  "Latife",
  "Leman",
  "Lemide",
  "Lerzan",
  "Leyla",
  "Lida",
  "Mehtap",
  "Melda",
  "Melek",
  "Melike",
  "Melis",
  "Melisa",
  "Melodi",
  "Meltem",
  "Meral",
  "Meriç:",
  "Merih",
  "Merve",
  "Meryem",
  "Mihriban",
  "Mine",
  "Miray",
  "Müesser",
  "Münevver",
  "Müge",
  "Müjde",
  "Müjgan",
  "Mukaddes",
  "Mısra",
  "Nalan",
  "Naz",
  "Nazan",
  "Nazlı",
  "Necla",
  "Nehir",
  "Nergis",
  "Neslişah",
  "Nesrin",
  "Nevin",
  "Nevra",
  "Nida",
  "Nigar",
  "Nihal",
  "Nihan",
  "Nil",
  "Nilgün",
  "Nisa",
  "Nisan",
  "Nükhet",
  "Nur",
  "Nural",
  "Nuran",
  "Nurgül",
  "Nursel",
  "Nurseli",
  "Okşan",
  "Olcay",
  "Oya",
  "Öykü",
  "Özden",
  "Özge",
  "Özlem",
  "Özlen",
  "Öznur",
  "Parla",
  "Pakize",
  "Pelin",
  "Pelinsu",
  "Pembe",
  "Peri",
  "Perihan",
  "Perran",
  "Pervin",
  "Petek",
  "Pınar",
  "Piraye",
  "Rabia",
  "Rahime",
  "Rahşan",
  "Rana",
  "Rengin",
  "Reyhan",
  "Rezzan",
  "Rüya",
  "Ruhsar",
  "Sanem",
  "Seçil",
  "Seda",
  "Sedef",
  "Seden",
  "Seher",
  "Selda",
  "Selen",
  "Selin",
  "Selma",
  "Selvi",
  "Sema",
  "Semra",
  "Senay",
  "Serap",
  "Sertap",
  "Seren",
  "Serin",
  "Serpil",
  "Sevda",
  "Sevgi",
  "Sevil",
  "Sevim",
  "Sevinç",
  "Sevtap",
  "Seval",
  "Sıla",
  "Sibel",
  "Simge",
  "Sinem",
  "Songül",
  "Su",
  "Sunay",
  "Suzan",
  "Şebnem",
  "Şehrazat",
  "Şelale",
  "Şenay",
  "Şengül",
  "Şennur",
  "Şermin",
  "Şeyda",
  "Şeyma",
  "Şevval",
  "Şiir",
  "Şule",
  "Tanyeli",
  "Tezer",
  "Tuba",
  "Tuğba",
  "Turna",
  "Tutku",
  "Tülay",
  "Tülin",
  "Türkan",
  "Tünay",
  "Tunay",
  "Utku",
  "Ulus",
  "Uhra",
  "Uygu",
  "Ulviye",
  "Ülfet",
  "Ülker",
  "Ülkü",
  "Ümmiye",
  "Ümran",
  "Ünsel",
  "Ünseli",
  "Vahide",
  "Verda",
  "Vesile",
  "Vicdan",
  "Vildan",
  "Vuslat",
  "Yaprak",
  "Yasemin",
  "Yağmur",
  "Yelda",
  "Yeliz",
  "Yeşim",
  "Yıldız",
  "Yonca",
  "Yosun",
  "Zahide",
  "Zehra",
  "Zekiye",
  "Zerrin",
  "Zeynep",
  "Zübeyde",
  "Zühal",
  "Zülal",
  "Züleyha",
  "Zeliha",
  "Zümrüt"
];

// Helper function to normalize names
function normalizeName(name) {
  const replacements = {
    "Ç": "C", "Ğ": "G", "İ": "I", "Ö": "O", "Ş": "S", "Ü": "U",
    "ç": "c", "ğ": "g", "ı": "i", "ö": "o", "ş": "s", "ü": "u"
  };
  return name
    .split('')
    .map(char => replacements[char] || char)
    .join('')
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .toLowerCase();
}

// Helper function to capitalize names
function toCapitalized(name) {
  return name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
}

// Updated isOneLetterTwoEmojis function with fallback
function isOneLetterTwoEmojis(str) {
  if (!str) return false;

  const firstChar = str.charAt(0);
  if (!/^[A-Za-z]$/.test(firstChar)) {
    return false;
  }

  const rest = str.slice(1).trim();

  let graphemes;
  if (typeof Intl.Segmenter === 'function') {
    const segmenter = new Intl.Segmenter(undefined, { granularity: 'grapheme' });
    graphemes = [...segmenter.segment(rest)].map(s => s.segment);
  } else {
    // Fallback: Use a regex to split into grapheme clusters
    graphemes = [...rest.matchAll(/./gu)].map(match => match[0]);
  }

  if (graphemes.length !== 2) {
    return false;
  }

  const emojiRegex = /\p{Extended_Pictographic}/u;
  return graphemes.every(grapheme => emojiRegex.test(grapheme));
}

// Main handler function
export default {
  async fetch(request, env, ctx) {
    if (!env.TELEGRAM_TOKEN || !env.BOT_NAME) {
      throw new Error('Environment variables TELEGRAM_TOKEN and BOT_NAME must be set.');
    }

    return handleRequest(request, env);
  }
};

async function handleRequest(request, env) {
  if (request.method !== 'POST') {
    return new Response('Method Not Allowed', { status: 405 });
  }

  let update;
  try {
    update = await request.json();
  } catch (error) {
    if (env.DEBUG_MODE === 'true') {
      console.error(`Error parsing request: ${error.message}`);
    }
    return new Response('Bad Request', { status: 400 });
  }

  // Handle /start command in private chat
  if (update.message && update.message.text === '/start' && update.message.chat.type === 'private') {
    const chatId = update.message.chat.id;
    await sendMessage(chatId, `
Merhaba! Ben bir emoji spam engelleme botuyum. Belirli bir kalıba uygun kullanıcıları tespit edip, gruptan otomatik olarak engellerim.
Lütfen beni grubunuza ekledikten sonra yönetici (admin) olarak atayın. Ancak bu şekilde tam kapasiteyle çalışabilirim.

Hello! I am an emoji spam prevention bot. I detect users matching a specific pattern and automatically ban them from the group.
Please set me as an admin after adding me to your group to ensure full functionality.
      `, env);
    return new Response('OK', { status: 200 });
  }

  // Handle new member joins
  if (update.message && update.message.new_chat_members) {
    const newMembers = update.message.new_chat_members;
    const chatId = update.message.chat.id;

    for (const member of newMembers) {
      // Check if the bot itself was added
      if (member.is_bot && member.username === env.BOT_NAME) {
        await sendMessage(chatId, `
Merhaba! Bu bot, belirli spam davranışlarına sahip kullanıcıları otomatik olarak engeller.
Botun doğru çalışabilmesi için, grup yöneticileri tarafından yönetici olarak atanmalıdır.

Hello! This bot automatically bans users who exhibit specific spam behaviors.
It needs to be set as an admin by group admins to work properly.
          `, env);
        continue;
      }

      const firstName = member.first_name?.normalize('NFC') || '';
      const lastName = member.last_name || '';
      const userName = member.username || '';
      const languageCode = member.language_code || '';

      const normalizedFirstName = toCapitalized(normalizeName(firstName));
      const normalizedNamesList = turkishGirlNames.map(name => toCapitalized(normalizeName(name)));

      // Match conditions
      const isNameMatch = normalizedNamesList.includes(normalizedFirstName);
      const isLastNameMatch = isOneLetterTwoEmojis(lastName);
      const isUsernameMatch = userName.startsWith(`@${normalizedFirstName}_`);
      const isLanguageMatch = languageCode === 'en';

      if (env.DEBUG_MODE === 'true') {
        console.log(`Checking member: ${firstName} ${lastName}, Username: ${userName}, Language: ${languageCode}`);
        console.log(`Name match: ${isNameMatch}, Last name match: ${isLastNameMatch}, Username match: ${isUsernameMatch}, Language match: ${isLanguageMatch}`);
      }

      if (isNameMatch && isLastNameMatch && isUsernameMatch && isLanguageMatch) {
        await banUser(chatId, member.id, env);
        if (env.DEBUG_MODE === 'true') {
          console.log(`Banned user: ${firstName} (ID: ${member.id})`);
        }
      }
    }
  }

  return new Response('OK', { status: 200 });
}

// Function to send a message to a user
async function sendMessage(chatId, message, env) {
  const url = `https://api.telegram.org/bot${env.TELEGRAM_TOKEN}/sendMessage`;

  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ chat_id: chatId, text: message })
    });

    const data = await response.json();
    if (!data.ok && env.DEBUG_MODE === 'true') {
      console.error(`Failed to send message: ${data.description}`);
    }
  } catch (error) {
    if (env.DEBUG_MODE === 'true') {
      console.error(`Error in sendMessage: ${error.message}`);
    }
  }
}

// Function to ban a user using Telegram API
async function banUser(chatId, userId, env) {
  const url = `https://api.telegram.org/bot${env.TELEGRAM_TOKEN}/banChatMember`;

  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ chat_id: chatId, user_id: userId })
    });

    const data = await response.json();
    if (!data.ok && env.DEBUG_MODE === 'true') {
      console.error(`Failed to ban user: ${data.description}`);
    }
  } catch (error) {
    if (env.DEBUG_MODE === 'true') {
      console.error(`Error in banUser: ${error.message}`);
    }
  }
}
